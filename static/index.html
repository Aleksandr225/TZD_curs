<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/static/index.css">
    <!-- Mammoth.js (–ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç DOCX –≤ HTML –≤ –±—Ä–∞—É–∑–µ—Ä–µ). –ê—Ç—Ä–∏–±—É—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –æ–ø—É—â–µ–Ω, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º –ø—Ä–∏ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤–µ—Ä—Å–∏–π; –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö CDN. -->
    <script id="mammothScript" src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.14/mammoth.browser.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
    // –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö CDN, –µ—Å–ª–∏ mammoth –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è (–Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã –±–ª–æ–∫–∏—Ä—É—é—Ç –∏–∑-–∑–∞ –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏—è integrity).
    (function(){
        function loadScript(url, onload, onerror) {
            var s = document.createElement('script');
            s.src = url; s.crossOrigin = 'anonymous'; s.referrerPolicy = 'no-referrer';
            s.onload = onload; s.onerror = onerror; document.head.appendChild(s);
        }
        function ensureLoaded(urls, i) {
            i = i || 0; if (window.mammoth) { console.debug('mammoth loaded already'); return; }
            if (i >= urls.length) { console.warn('mammoth.js could not be loaded from any CDN'); return; }
            console.debug('Attempting to load mammoth from', urls[i]);
            loadScript(urls[i], function(){ console.debug('Loaded mammoth from', urls[i]); }, function(){ ensureLoaded(urls, i+1); });
        }
        // –ï—Å–ª–∏ –Ω–∞—á–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª window.mammoth –ø–æ—Å–ª–µ –º–∏–∫—Ä–æ—Ç–∞—Å–∫–∞ ‚Äî –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ CDN
        setTimeout(function(){ if (!window.mammoth) {
            ensureLoaded([
                'https://cdn.jsdelivr.net/npm/mammoth@1.4.14/dist/mammoth.browser.min.js',
                'https://unpkg.com/mammoth@1.4.14/dist/mammoth.browser.min.js'
            ]);
        } else {
            console.debug('mammoth available from primary CDN');
        } }, 50);
    })();
    </script>
    <title>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç ‚Äî –ü—É—Å—Ç–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</title>
</head>
<body>
    <div id="scriptError" class="script-error" style="display:none; position:fixed; top:10px; left:50%; transform:translateX(-50%); background:#fee2e2; color:#991b1b; border:1px solid #fecaca; padding:10px 12px; border-radius:8px; z-index:9999; box-shadow: 0 8px 20px rgba(0,0,0,0.06); font-weight:600;">
        –°–∫—Ä–∏–ø—Ç: –æ—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–æ—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π)
    </div>
    <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å –≤–∫–ª–∞–¥–æ–∫ –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã: "–†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏ / –°—Ö–µ–º–∞ —É—á–µ—Ç–∞ / –§–æ—Ä–º—ã —É—á–µ—Ç–∞" -->
    <div class="top-tabs" role="navigation">
        <div class="top-tabs-inner container">
            <ul class="top-tab-bar" role="tablist">
                <li class="top-tab-item active" data-tab="top-files" role="tab">–†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏</li>
                <li class="top-tab-item" data-href="/static/workflow.html" role="tab">–°—Ö–µ–º–∞ —É—á–µ—Ç–∞</li>
                <li class="top-tab-item" data-href="/static/forms.html" role="tab">–§–æ—Ä–º—ã —É—á–µ—Ç–∞</li>
            </ul>
            <div class="top-user-info" aria-hidden="true">
                <div class="user-avatar" title="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å">A</div>
                <div class="user-name">–ê–ª–µ–∫—Å–∞–Ω–¥—Ä</div>
            </div>
            <div class="top-tab-content">
                <div id="top-files" class="top-tab-pane" style="display:block;"></div>
                <div id="top-workflow" class="top-tab-pane" style="display:none;"></div>
                <div id="top-forms" class="top-tab-pane" style="display:none;"></div>
            </div>
        </div>
    </div>

    <div class="main-wrapper">
        <aside class="sidebar">
            <h2>–†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã –ø—Ä–æ–≥—Ä–∞–º–º—ã</h2>
            <button class="cipher-btn" data-mode="kuznechik">–ö—É–∑–Ω–µ—á–∏–∫ (—Å–∏–º–º.)</button>
            <button class="cipher-btn" data-mode="hash">–•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
            <button class="cipher-btn" data-mode="sign">–í—ã—Ä–∞–±–æ—Ç–∫–∞ –≠–¶–ü</button>
            <button class="cipher-btn" data-mode="keygen">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π</button>
        </aside>

        <div class="main-content">
                <div class="container">
                    <div id="workspace" style="min-height:420px; display:flex; align-items:flex-start; justify-content:center; border:1px dashed #e5e7eb; border-radius:8px; background: #fff; padding:18px;">
                        <div id="modeContent" style="width:100%;">
                            <!-- –û–±–ª–∞—Å—Ç—å –æ–ø–∏—Å–∞–Ω–∏—è —Ä–µ–∂–∏–º–∞ (–Ω–µ–±–æ–ª—å—à–∞—è) -->
                            <div id="modeDescription" class="mode-description" style="margin-bottom:8px;">–û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–∂–∏–º–∞</div>
                            <!-- –£–±—Ä–∞–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ "–í—ã–±—Ä–∞–Ω —Ä–µ–∂–∏–º" –ø–æ –ø—Ä–æ—Å—å–±–µ UX (—ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω—É–∂–µ–Ω) -->

                            <!-- –°—Ç—Ä–æ–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞: input + –∫–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ –æ–¥–Ω–æ–π –ª–∏–Ω–∏–∏ -->
                            <div id="workspaceControls" class="workspace-row" style="display:flex; flex-direction:column; gap:12px; align-items:stretch;">
                                <div id="kuzControls">
                                <!-- –†–µ–∂–∏–º "–ö—É–∑–Ω–µ—á–∏–∫": –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –ó–∞—à–∏—Ñ—Ä–æ–≤–∞—Ç—å/–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å -->
                                <div class="kuz-mode-toggle" style="display:flex; gap:8px; margin-bottom:8px; align-items:center;">
                                    <button id="kuzModeEncryptBtn" class="btn-small primary" type="button">–ó–∞—à–∏—Ñ—Ä–æ–≤–∞—Ç—å</button>
                                    <button id="kuzModeDecryptBtn" class="btn-small" type="button">–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å</button>
                                    <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ –∫–ª—é—á–∞ –¥–ª—è —Ä–µ–∂–∏–º–∞ –ö—É–∑–Ω–µ—á–∏–∫: –≤–∏–¥–Ω–æ —Å–ø—Ä–∞–≤–∞ –æ—Ç –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–π -->
                                    <label for="kuzKeyInput" style="margin-left:auto; margin-right:8px; color:#475569; font-weight:500; font-size:13px;">–ö–ª—é—á:</label>
                                    <div class="input-with-copy" style="max-width:340px; width:100%;">
                                        <input id="kuzKeyInput" class="form-input" type="text" placeholder="–ö–ª—é—á –¥–ª—è –ö—É–∑–Ω–µ—á–∏–∫–∞ (hex)" title="–û–∂–∏–¥–∞–µ—Ç—Å—è hex-—Å—Ç—Ä–æ–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: A1B2C3...)" style="width:100%; font-family:monospace;" />
                                    </div>
                                </div>

                                <!-- –ü–æ–¥–ø–∞–Ω–µ–ª–∏ –ö—É–∑–Ω–µ—á–∏–∫–∞: –∑–∞—à–∏—Ñ—Ä–æ–≤–∞—Ç—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å -->
                                <div id="kuzEncryptPanel" style="display:block; margin-bottom:8px;">
                                    <!-- –î–µ–π—Å—Ç–≤–∏–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω–æ –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–∞–Ω–µ–ª–∏ –¥–µ–π—Å—Ç–≤–∏–π (`doc-actions`) (—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞) -->
                                </div>
                                <div id="kuzDecryptPanel" style="display:none; margin-bottom:8px; gap:8px;">
                                    <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
                                        <input id="kuzDecryptFileInput" type="file" accept="*/*" style="display:none;" />
                                        <button id="kuzDecryptChooseBtn" class="btn-small" type="button">–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç</button>
                                        <span id="kuzDecryptSelectedFile" style="color:#475569;">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</span>
                                    </div>
                                    <div style="display:flex; gap:8px; align-items:center;">
                                        <div style="display:flex; gap:8px; width:100%;">
                                            <button id="kuzDecryptBottomClearBtn" class="btn-small" type="button" style="flex:1;">–û—á–∏—Å—Ç–∏—Ç—å</button>
                                            <button id="kuzDecryptActionDownloadBtn" class="btn-small primary" type="button" style="flex:1;">–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å –∏ —Å–∫–∞—á–∞—Ç—å</button>
                                        </div>
                                    </div>
                                    <div id="kuzDecryptOutput" style="display:none; margin-top:8px; background:#fbfbfc; padding:8px; border-radius:6px; border:1px solid #e6eef8;">
                                        <h4 style="margin:0 0 6px 0;">–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏:</h4>
                                        <pre id="kuzDecryptText" style="white-space:pre-wrap; word-break:break-all; margin:0;"></pre>
                                    </div>
                                </div>
                                <div id="globalFileRow" class="file-row" style="display:flex; gap:10px; align-items:center;">
                                    <div class="file-step" style="display:flex; align-items:center; gap:8px; min-width:140px;">
                                        <span class="step-badge">1</span>
                                        <label class="file-label">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</label>
                                    </div>
                                    <div class="file-select" style="display:flex; gap:8px; align-items:center; flex:1;">
                                        <input id="workspaceFileInput" type="file" accept=".txt,.json,.md,.docx,.pdf,.png,.jpg,.jpeg,.bmp,.doc" style="display:none;" />
                                        <button id="customFileBtn" type="button" class="btn-small">–í—ã–±—Ä–∞—Ç—å</button>
                                        <span id="selectedFileName" class="file-name">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</span>
                                        <p id="fileNameDisplay" style="margin:0; color:#475569; font-size:13px;">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</p>
                                    </div>
                                    <div class="upload-step" style="display:flex; align-items:center; gap:8px;">
                                        <span class="step-badge step-small">2</span>
                                        <button id="workspaceUploadBtn" class="btn-small primary" type="button">–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç</button>
                                    </div>
                                </div>

                                <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å–ª–µ–¥—É–µ—Ç –Ω–∏–∂–µ —Å—Ç—Ä–æ–∫–∏ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ -->
                                <div id="mammothNotice" style="display:none; margin-bottom:8px; color:#92400e; background:#fff7ed; border:1px solid #ffd8a8; padding:8px; border-radius:6px; font-size:13px;">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä DOCX –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞.</div>
                                <div id="docPreview" style="border:1px solid #ddd; padding:12px; border-radius:8px; min-height:260px; background:#fff; overflow:auto;">
                                    <div id="docPreviewContent" style="min-height:160px;">–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞</div>
                                </div>

                                <!-- –ö–Ω–æ–ø–∫–∏ –ø–æ–¥ –ø—Ä–µ–≤—å—é: —Å–ª–µ–≤–∞/–ø–æ —Ü–µ–Ω—Ç—Ä—É/—Å–ø—Ä–∞–≤–∞ -->
                                <div class="doc-actions" style="margin-top:6px;">
                                    <div><button id="workspaceClearBtn" type="button" class="btn-small">–û—á–∏—Å—Ç–∏—Ç—å</button></div>
                                    <div><button id="workspaceEncryptBtn" type="button" class="btn-small primary">–ó–∞—à–∏—Ñ—Ä–æ–≤–∞—Ç—å –∏ —Å–∫–∞—á–∞—Ç—å</button></div>
                                    <div><button id="workspaceSendBtn" type="button" class="btn-small">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ —É—á—ë—Ç–∞</button></div>
                                </div>
                                </div>
                                <!-- –ö–æ–Ω—Ç—Ä–æ–ª—ã —Ä–µ–∂–∏–º–∞ –ø–æ–¥–ø–∏—Å–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç—ã) -->
                                <div id="signControls" style="display:none; flex-direction:column; gap:8px; margin-top:12px;">
                                    <div class="file-row" style="display:flex; gap:10px; align-items:center;">
                                        <div class="file-step" style="display:flex; align-items:center; gap:8px; min-width:140px;">
                                            <span class="step-badge">1</span>
                                            <label class="file-label">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç</label>
                                        </div>
                                        <div class="file-select" style="display:flex; gap:8px; align-items:center; flex:1;">
                                            <button id="signFileBtn" type="button" class="btn-small">–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç</button>
                                            <input type="file" id="signFileInput" style="display: none;" accept=".pdf,.doc,.docx,.txt">  <!-- –°–∫—Ä—ã—Ç—ã–π input, –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã -->

                                            <span id="signSelectedFileName" class="file-name">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</span>
                                        </div>
                                    </div>
                                    <div style="display:flex; gap:8px; align-items:center; justify-content:flex-start;">
                                        <button id="signGenerateBtn" class="btn-small primary" type="button" disabled>–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å—å</button>
                                    </div>
                                </div>
                                <!-- –ö–æ–Ω—Ç—Ä–æ–ª—ã —Ä–µ–∂–∏–º–∞ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç—ã) -->
                                <div id="hashBlock" style="display:none; flex-direction:column; gap:8px; margin-top:12px;">
                                    <h2 style="margin:0 0 6px 0;">–•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
                                    <div class="file-row" style="display:flex; gap:8px; align-items:center;">
                                        <div class="file-step" style="display:flex; align-items:center; gap:8px; min-width:140px;">
                                            <span class="step-badge">1</span>
                                            <label class="file-label">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</label>
                                        </div>
                                        <div class="file-select" style="display:flex; gap:8px; align-items:center; flex:1;">
                                            <button id="hashChooseBtn" type="button" class="btn-small">–í—ã–±—Ä–∞—Ç—å</button>
                                            <span id="hashSelectedFileName" class="file-name">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</span>
                                        </div>
                                    </div>
                                    <div style="display:flex; gap:8px; align-items:center;">
                                        <button id="hashButton" class="btn-small" type="button">–ü–æ—Å—á–∏—Ç–∞—Ç—å —Ö—ç—à</button>
                                    </div>
                                    <div id="hashResult" style="display:none; margin-top:8px; background:#fbfbfc; border:1px solid #e6eef8; padding:8px; border-radius:6px;">
                                        <h3 style="margin:0 0 4px 0;">–•—ç—à —Ñ–∞–π–ª–∞ (–°—Ç—Ä–∏–±–æ–≥-512):</h3>
                                        <div style="display:flex; gap:8px; align-items:flex-start;">
                                            <pre id="hashValue" style="font-family:monospace; margin:0; white-space:pre-wrap; word-break:break-all; flex:1;"></pre>
                                            <div style="display:flex; flex-direction:column; gap:8px;">
                                                <button id="hashCopyBtn" type="button" class="btn-small" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ö–µ—à">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- –ö–æ–Ω—Ç—Ä–æ–ª—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–µ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç—ã) -->
                                <div id="keygenBlock" style="display:none; flex-direction:column; gap:8px; margin-top:12px;">
                                    <div style="display:flex; gap:8px; align-items:center;">
                                        <button id="generateKeyButton" class="btn-small primary" type="button">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á</button>
                                    </div>
                                    <div id="keyArea" style="display:none; margin-top:10px;">
                                        <div style="display:flex; gap:8px; align-items:center;">
                                            <input id="generatedKeyInput" readonly style="flex:1; padding:8px; border-radius:6px; border:1px solid #e6eef8; background:#fff; font-family: monospace;" placeholder="–ö–ª—é—á –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å..." />
                                            <button id="copyKeyIcon" type="button" class="btn-small" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å">üìã</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ (—É–¥–æ–±–Ω–æ –¥–ª—è –Ω–µ—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤)
    window.addEventListener('error', function (e) {
        try { const banner = document.getElementById('scriptError'); if (banner) { banner.style.display = 'block'; banner.textContent = '–û—à–∏–±–∫–∞: ' + (e && e.message ? e.message : 'Unknown error'); } } catch (x) {}
        console.error('Global error', e);
    });
    window.addEventListener('unhandledrejection', function (ev) { try { const banner = document.getElementById('scriptError'); if (banner) { banner.style.display = 'block'; banner.textContent = 'Unhandled Promise rejection: ' + (ev.reason && ev.reason.message ? ev.reason.message : String(ev.reason)); } } catch (x){}; console.error('Unhandled promise rejection', ev); });
    // –ü–æ–≤–µ–¥–µ–Ω–∏–µ –≤–µ—Ä—Ö–Ω–∏—Ö –≤–∫–ª–∞–¥–æ–∫
    document.addEventListener('DOMContentLoaded', function() {
        console.debug('Top tabs DOMContentLoaded');
        const items = document.querySelectorAll('.top-tab-item');
        items.forEach(it => it.addEventListener('click', function() {
            // –ï—Å–ª–∏ —É –≤–∫–ª–∞–¥–∫–∏ –µ—Å—Ç—å –∞—Ç—Ä–∏–±—É—Ç data-href ‚Äî –ø–µ—Ä–µ–π—Ç–∏ –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –∞–¥—Ä–µ—Å—É
            const href = this.getAttribute('data-href');
            if (href) { window.location.href = href; return; }
            items.forEach(i => i.classList.remove('active'));
            this.classList.add('active');
            const target = this.getAttribute('data-tab');
            document.querySelectorAll('.top-tab-pane').forEach(p => p.style.display = 'none');
            const pane = document.getElementById(target);
            if (pane) pane.style.display = 'block';    
        }));
        

        
        document.getElementById('signFileBtn').addEventListener('click', function() {
            document.getElementById('signFileInput').click();  // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–∫—Ä—ã—Ç—ã–π input
        });

        // –ö–æ–≥–¥–∞ —Ñ–∞–π–ª –≤—ã–±—Ä–∞–Ω, –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        document.getElementById('signFileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('signSelectedFileName').textContent = file.name;  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞
                document.getElementById('signGenerateBtn').disabled = false;  // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É "–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å—å"
            } else {
                document.getElementById('signSelectedFileName').textContent = '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
                document.getElementById('signGenerateBtn').disabled = true;
            }
        });


        document.getElementById('signGenerateBtn').addEventListener('click', async function() {
            const fileInput = document.getElementById('signFileInput');
            const file = fileInput.files[0];
            if (!file) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª.');
                return;
            }

            // –°–æ–∑–¥–∞—ë–º FormData –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞
            const formData = new FormData();
            formData.append('file', file);

            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –Ω–∞ Flask-—Ä–æ—É—Ç /sig
                const response = await fetch('/sig', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
                }

                // –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–π–ª –∫–∞–∫ Blob
                const blob = await response.blob();
                
                // –°–æ–∑–¥–∞—ë–º URL –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                const url = window.URL.createObjectURL(blob);
                
                // –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                const a = document.createElement('a');
                a.href = url;
                a.download = 'sig.sig';  // –ò–º—è —Ñ–∞–π–ª–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ (–∫–∞–∫ –≤ –≤–∞—à–µ–º Flask-–∫–æ–¥–µ)
                document.body.appendChild(a);
                a.click();  // –ò–Ω–∏—Ü–∏–∏—Ä—É–µ–º —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
                
                // –û—á–∏—â–∞–µ–º URL –∏ —Å—Å—ã–ª–∫—É
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                alert('–§–∞–π–ª —Å –ø–æ–¥–ø–∏—Å—å—é —Å–∫–∞—á–∞–Ω!');  // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                
                // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —Å–±—Ä–æ—Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
                fileInput.value = '';
                document.getElementById('signSelectedFileName').textContent = '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
                document.getElementById('signGenerateBtn').disabled = true;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–∞–π–ª–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.');
            }
        });

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—É—Ç–∏ URL
        function setActiveTopTabByPath() {
            const path = window.location.pathname || '/';
            if (path.endsWith('/static/workflow.html')) {
                    const el = document.querySelector('.top-tab-item[data-href="/static/workflow.html"]'); if (el) el.classList.add('active');
                } else if (path.endsWith('/static/forms.html')) {
                    const el = document.querySelector('.top-tab-item[data-href="/static/forms.html"]'); if (el) el.classList.add('active');
            } else {
                // –∏–Ω–¥–µ–∫—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                const el = document.querySelector('.top-tab-item[data-tab="top-files"]'); if (el) el.classList.add('active');
            }
        }
        setActiveTopTabByPath();
    });

    // –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å —Ä–∞–±–æ—á–µ–π –æ–±–ª–∞—Å—Ç—å—é
    document.addEventListener('DOMContentLoaded', function() {
        console.debug('Workspace DOMContentLoaded');
        // –ü–æ–∫–∞–∑–∞—Ç—å –Ω–µ–±–æ–ª—å—à–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ mammoth –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        try { if (mammothNotice) mammothNotice.style.display = (window.mammoth ? 'none' : 'block'); } catch (x) {}
    (function() {
        const leftBtns = document.querySelectorAll('.cipher-btn');
        const desc = document.getElementById('modeDescription');
        const previewContent = document.getElementById('docPreviewContent');
        const fileInput = document.getElementById('workspaceFileInput');
        const customFileBtn = document.getElementById('customFileBtn');
        const selectedFileName = document.getElementById('selectedFileName');
        const uploadBtn = document.getElementById('workspaceUploadBtn');
        const clearBtn = document.getElementById('workspaceClearBtn');
        const encryptBtn = document.getElementById('workspaceEncryptBtn');
        const sendBtn = document.getElementById('workspaceSendBtn');
        const workspaceControls = document.getElementById('workspaceControls');
        const mammothNotice = document.getElementById('mammothNotice');
        const signControls = document.getElementById('signControls');
        const kuzControls = document.getElementById('kuzControls');
        const kuzModeEncryptBtn = document.getElementById('kuzModeEncryptBtn');
        const kuzModeDecryptBtn = document.getElementById('kuzModeDecryptBtn');
        const kuzEncryptPanel = document.getElementById('kuzEncryptPanel');
        const kuzDecryptPanel = document.getElementById('kuzDecryptPanel');
        const kuzDecryptChooseBtn = document.getElementById('kuzDecryptChooseBtn');
        const kuzDecryptFileInput = document.getElementById('kuzDecryptFileInput');
        const kuzDecryptSelectedFile = document.getElementById('kuzDecryptSelectedFile');
        const kuzDecryptBottomClearBtn = document.getElementById('kuzDecryptBottomClearBtn');
        const kuzDecryptActionDownloadBtn = document.getElementById('kuzDecryptActionDownloadBtn');
        const kuzDecryptOutput = document.getElementById('kuzDecryptOutput');
        const kuzDecryptText = document.getElementById('kuzDecryptText');
        const kuzKeyInput = document.getElementById('kuzKeyInput');
        // kuzKeyToggle removed - no show/hide behavior needed
        
        const signFileBtn = document.getElementById('signFileBtn');
        const signSelectedFileName = document.getElementById('signSelectedFileName');
        const signGenerateBtn = document.getElementById('signGenerateBtn');
        const signatureDate = document.getElementById('signatureDate');
        const signatureCopyBtn = document.getElementById('signatureCopyBtn');
        // –ü–æ–ª–µ selectedModeName —É–¥–∞–ª–µ–Ω–æ ‚Äî –±–æ–ª—å—à–µ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º '–í—ã–±—Ä–∞–Ω —Ä–µ–∂–∏–º'
        const hashBlock = document.getElementById('hashBlock');
        const hashButton = document.getElementById('hashButton');
        const hashChooseBtn = document.getElementById('hashChooseBtn');
        const hashSelectedFileName = document.getElementById('hashSelectedFileName');
        const hashResult = document.getElementById('hashResult');
        const hashValue = document.getElementById('hashValue');
        const keygenBlock = document.getElementById('keygenBlock');
        const generateKeyButton = document.getElementById('generateKeyButton');
        const keyArea = document.getElementById('keyArea');
        const generatedKeyInput = document.getElementById('generatedKeyInput');
        const copyKeyIcon = document.getElementById('copyKeyIcon');
        const hashCopyBtn = document.getElementById('hashCopyBtn');

        const descMap = {
            kuznechik: '–ö—É–∑–Ω–µ—á–∏–∫ ‚Äî –æ—Ç–µ—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –±–ª–æ—á–Ω—ã–π —Å–∏–º–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è (–ì–û–°–¢). –í —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç, –ø–æ–ª—É—á–∏—Ç—å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –∏–ª–∏ —Å–∫–∞—á–∞—Ç—å –µ–≥–æ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –ø–æ–º–æ–≥–∞–µ—Ç –∑–∞—â–∏—Ç–∏—Ç—å –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö, –æ–¥–Ω–∞–∫–æ –≤–∞–∂–Ω–æ –Ω–∞–¥—ë–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –∏ –ø–æ–º–Ω–∏—Ç—å –∞–ª–≥–æ—Ä–∏—Ç–º—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞.',
            hash: '–•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ü–∏—Ñ—Ä–æ–≤–æ–≥–æ –æ—Ç–ø–µ—á–∞—Ç–∫–∞ (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞) —Ñ–∞–π–ª–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä —Å –ø–æ–º–æ—â—å—é –∞–ª–≥–æ—Ä–∏—Ç–º–∞ –°—Ç—Ä–∏–±–æ–≥. –•–µ—à –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ –±—ã—Å—Ç—Ä–æ —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å –≤–µ—Ä—Å–∏–∏ –±–µ–∑ –ø–µ—Ä–µ–¥–∞—á–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ; —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –Ω–µ–∏–∑–º–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –∞—É–¥–∏—Ç–∞. –ï—Å–ª–∏ —Ö–µ—à —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Äî —Ñ–∞–π–ª –Ω–µ –∏–∑–º–µ–Ω—è–ª—Å—è, –µ—Å–ª–∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è ‚Äî –º–æ–∂–µ—Ç —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞—Ç—å –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –∏–ª–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–∏.',
            sign: '–í—ã—Ä–∞–±–æ—Ç–∫–∞ –≠–¶–ü ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ–¥–ø–∏—Å–∏, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–µ–π –∞–≤—Ç–æ—Ä—Å—Ç–≤–æ –∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞. –ü–æ–¥–ø–∏—Å—å –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –≤–∞—à–µ–≥–æ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ –∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥—Ä—É–≥–∏–º —Å—Ç–æ—Ä–æ–Ω–∞–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç –Ω–µ –±—ã–ª –∏–∑–º–µ–Ω—ë–Ω –ø–æ—Å–ª–µ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è. –ü–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∞ —É—á—ë—Ç –∏–ª–∏ —Ö—Ä–∞–Ω–∏—Ç—å —Å –æ—Ç–º–µ—Ç–∫–æ–π –æ –ø–æ–¥–ø–∏—Å–∏ ‚Äî –ø—Ä–∏ —ç—Ç–æ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø–æ–¥–ø–∏—Å–∏ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞.',
            keygen: '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –∫–ª—é—á–µ–π –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ: —Å–∏–º–º–µ—Ç—Ä–∏—á–Ω—ã—Ö –∫–ª—é—á–µ–π –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ –ø–∞—Ä—ã ¬´–ø—É–±–ª–∏—á–Ω—ã–π/–ø—Ä–∏–≤–∞—Ç–Ω—ã–π¬ª –¥–ª—è –ø–æ–¥–ø–∏—Å–∏. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–ª—é—á–∏ —Å–ª–µ–¥—É–µ—Ç —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ —Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –º–µ—Å—Ç–µ; –ø–æ—Ç–µ—Ä—è –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ –ø—Ä–∏–≤–µ–¥—ë—Ç –∫ —É—Ç—Ä–∞—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞—Ç—å –∏–ª–∏ –ø–æ–¥–ø–∏—Å—ã–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç —Ä–µ–∂–∏–º, —á—Ç–æ–±—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∫–ª—é—á–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π —Ä–∞–±–æ—Ç—ã –≤ –¥—Ä—É–≥–∏—Ö —Ä–µ–∂–∏–º–∞—Ö (—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ, –ø–æ–¥–ø–∏—Å—å, –ø—Ä–æ–≤–µ—Ä–∫–∞).'
        };

        // modeNameMap —É–¥–∞–ª—ë–Ω ‚Äî –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω

        let currentMode = null;
        let currentContent = '';
        let currentBlobUrl = null;

        function setMode(mode, btnEl) {
            currentMode = mode;
            console.debug('setMode called', mode);
            // –ü–æ–¥—Å–≤–µ—Ç–∏—Ç—å –∫–Ω–æ–ø–∫–∏ –≤ –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏
            leftBtns.forEach(b => b.classList.toggle('active', b === btnEl));
            // –û–±–Ω–æ–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            if (desc) { desc.textContent = descMap[mode] || ''; desc.style.display = 'block'; }
            // –≠–ª–µ–º–µ–Ω—Ç —Å —Ç–µ–∫—Å—Ç–æ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤: —Ä–∞–±–æ—á–∞—è –æ–±–ª–∞—Å—Ç—å –≤–∫–ª—é—á–∞–µ—Ç –ø—Ä–µ–≤—å—é –∏ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ–∂–∏–º–∞
            if (workspaceControls) workspaceControls.style.display = (mode === 'kuznechik' || mode === 'sign' || mode === 'hash' || mode === 'keygen') ? 'flex' : 'none';
            if (kuzControls) kuzControls.style.display = (mode === 'kuznechik') ? 'block' : 'none';
            if (signControls) signControls.style.display = (mode === 'sign') ? 'flex' : 'none';
            if (hashBlock) hashBlock.style.display = (mode === 'hash') ? 'flex' : 'none';
            if (keygenBlock) keygenBlock.style.display = (mode === 'keygen') ? 'flex' : 'none';
            // When entering Kuznechik, default to Encrypt panel and ensure global encrypt button is visible in doc-actions
            if (mode === 'kuznechik') {
                if (kuzModeEncryptBtn) kuzModeEncryptBtn.classList.add('primary');
                if (kuzModeDecryptBtn) kuzModeDecryptBtn.classList.remove('primary');
                if (kuzEncryptPanel) kuzEncryptPanel.style.display = 'block';
                if (kuzDecryptPanel) kuzDecryptPanel.style.display = 'none';
                if (encryptBtn) encryptBtn.style.display = '';
                try { const gf = document.getElementById('globalFileRow'); if (gf) gf.style.display = 'flex'; } catch (e) {}
            } else {
                if (encryptBtn) encryptBtn.style.display = '';
            }
            if (mode === 'sign') {
                try { if (signControls) { signControls.scrollIntoView({ behavior: 'smooth', block: 'center' }); } if (signFileBtn) { signFileBtn.focus(); } } catch (e) { console.debug('scroll/focus failed', e); }
            }
            // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤–µ—Ä—Ö–Ω—é—é –≤–∫–ª–∞–¥–∫—É –Ω–∞ —Ä–∞–±–æ—Ç—É —Å —Ñ–∞–π–ª–∞–º–∏ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ä–µ–∂–∏–º–∞ –ö—É–∑–Ω–µ—á–∏–∫
            if (mode === 'kuznechik') {
                const t = document.querySelector('.top-tab-item[data-tab="top-files"]'); if (t) t.click();
            }
            // –°–±—Ä–æ—Å –ø—Ä–µ–≤—å—é –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ —Ä–µ–∂–∏–º
            if (previewContent) previewContent.textContent = '–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞'; currentContent = '';
            clearExistingBlob();
            if (mammothNotice) mammothNotice.style.display = (window.mammoth ? 'none' : 'block');
            if (fileInput) fileInput.value = null;
            if (selectedFileName) selectedFileName.textContent = '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
            const fnDisplay = document.getElementById('fileNameDisplay'); if (fnDisplay) fnDisplay.textContent = '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
            if (signSelectedFileName) signSelectedFileName.textContent = '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
            if (signatureDate) signatureDate.textContent = '‚Äî';
            // Reset hash and keygen UI
            if (hashResult) { hashResult.style.display = 'none'; }
            if (hashValue) { hashValue.textContent = ''; hashValue.style.color = ''; }
            if (generatedKeyInput) { generatedKeyInput.value = ''; }
            if (keyArea) { keyArea.style.display = 'none'; }
        }

        // Ensure initial disabled/enabled states
        try { if (hashButton) hashButton.disabled = true; } catch(x){}

        leftBtns.forEach(b => {
            b.addEventListener('click', () => { console.debug('left button clicked', b.dataset.mode); setMode(b.dataset.mode, b); });
        });

        // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π —Ä–µ–∂–∏–º ‚Äî –±—ã—Ç—å —Ç–æ–ª–µ—Ä–∞–Ω—Ç–Ω–µ–µ, –µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –∫–Ω–æ–ø–æ–∫ –ø—É—Å—Ç
        if (leftBtns && leftBtns.length) {
            setMode(leftBtns[0].dataset.mode || 'kuznechik', leftBtns[0]);
        } else {
            console.warn('No mode buttons found, defaulting to kuznechik but no UI for it');
            setMode('kuznechik', null);
        }

        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ "–í—ã–±—Ä–∞—Ç—å": –æ—Ç–∫—Ä—ã—Ç—å –¥–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ –∏ –æ–±–Ω–æ–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ä–µ–∂–∏–º–∞—Ö)
        if (customFileBtn && fileInput) customFileBtn.addEventListener('click', () => { console.debug('customFileBtn clicked'); fileInput.click(); });
        if (fileInput) fileInput.addEventListener('change', () => {
            const f = fileInput.files && fileInput.files[0];
            console.debug('file selected', f && f.name);
            const fmt = (size) => {
                if (!size && size !== 0) return '';
                if (size < 1024) return `${size} –ë`;
                const kb = size / 1024; if (kb < 1024) return `${kb.toFixed(1)} –ö–ë`;
                const mb = kb / 1024; return `${mb.toFixed(2)} –ú–ë`;
            };
            const displayText = f ? `–í—ã–±—Ä–∞–Ω: ${f.name} (${fmt(f.size)})` : '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
            if (selectedFileName) { selectedFileName.textContent = displayText; selectedFileName.classList.toggle('selected', !!f); }
            if (signSelectedFileName) { signSelectedFileName.textContent = displayText; signSelectedFileName.classList.toggle('selected', !!f); }
            const fileNameDisplay = document.getElementById('fileNameDisplay');
            if (fileNameDisplay) fileNameDisplay.textContent = displayText;
            if (signGenerateBtn) signGenerateBtn.disabled = !f;
            if (hashButton) hashButton.disabled = !f;
            if (hashSelectedFileName) { hashSelectedFileName.textContent = displayText; hashSelectedFileName.classList.toggle('selected', !!f); }
            if (hashButton) hashButton.disabled = !f;
        });
        // –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ `commonFileInput`
        const commonFileEl = document.getElementById('commonFileInput');
        if (commonFileEl) {
            commonFileEl.addEventListener('change', (ev) => {
                const f = ev.target.files && ev.target.files[0];
                const fmt = (size) => { if (!size && size !== 0) return ''; if (size < 1024) return `${size} –ë`; const kb = size / 1024; if (kb < 1024) return `${kb.toFixed(1)} –ö–ë`; const mb = kb / 1024; return `${mb.toFixed(2)} –ú–ë`; };
                const displayText = f ? `–í—ã–±—Ä–∞–Ω: ${f.name} (${fmt(f.size)})` : '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
                if (selectedFileName) selectedFileName.textContent = displayText;
                if (signSelectedFileName) signSelectedFileName.textContent = displayText;
                const fnd = document.getElementById('fileNameDisplay'); if (fnd) fnd.textContent = displayText;
                if (signGenerateBtn) signGenerateBtn.disabled = !f;
                if (hashButton) hashButton.disabled = !f;
                // Also propagate file to workspace input so preview works if desired
                try { if (fileInput) { fileInput.files = ev.target.files; } } catch(e) { /* –Ω–µ –≤–æ –≤—Å–µ—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å file input */ }
            });
        }
        // –ö–Ω–æ–ø–∫–∞ –≤ —Ä–µ–∂–∏–º–µ –ø–æ–¥–ø–∏—Å–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ç–æ—Ç –∂–µ –¥–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
        
        // Hash choose button opens the same workspace file dialog
        if (hashChooseBtn && fileInput) hashChooseBtn.addEventListener('click', () => { console.debug('hashChooseBtn clicked'); fileInput.click(); });

        // –†–µ–∂–∏–º —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è: –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ö–µ—à–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        if (hashButton) hashButton.addEventListener('click', () => { console.debug('hashButton clicked'); sendHash(); });
        if (hashCopyBtn) hashCopyBtn.addEventListener('click', async () => {
            if (!hashValue || !hashValue.textContent) return;
            try { await navigator.clipboard.writeText(hashValue.textContent.replace(/\s+/g, '')); alert('–•–µ—à —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞'); }
            catch (e) { try { const ta = document.createElement('textarea'); ta.value = hashValue.textContent.replace(/\s+/g, ''); document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); alert('–•–µ—à —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω (fallback)'); } catch (ex) { alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ö–µ—à'); } }
        });

        // –†–µ–∂–∏–º –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–∞: —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
        if (generateKeyButton) generateKeyButton.addEventListener('click', () => {
            const key = generateKey();
        });
        if (copyKeyIcon) {
            copyKeyIcon.addEventListener('click', async () => {
                if (!generatedKeyInput || !generatedKeyInput.value) return;
                try { await navigator.clipboard.writeText(generatedKeyInput.value); alert('–ö–ª—é—á —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞'); }
                catch (err) {
                    try { generatedKeyInput.select(); document.execCommand('copy'); alert('–ö–ª—é—á —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω (fallback)'); } catch (e) { console.error('copy failed', e); alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'); }
                }
            });
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å ArrayBuffer –≤ base64
        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }

        function clearExistingBlob() {
            if (currentBlobUrl) {
                try { URL.revokeObjectURL(currentBlobUrl); } catch (e) {}
                currentBlobUrl = null;
            }
        }

        function showPreviewForFile(file) {
            if (!file || !previewContent) return;
            clearExistingBlob();
            const name = file.name || 'file';
            const ext = (name.split('.').pop() || '').toLowerCase();
            // Reset area
            previewContent.innerHTML = '';

            // Images
            if (file.type && file.type.startsWith('image/')) {
                const url = URL.createObjectURL(file);
                currentBlobUrl = url;
                const img = document.createElement('img');
                img.src = url;
                img.alt = name;
                img.className = 'preview-img';
                previewContent.appendChild(img);
                // For encryption, store base64 of binary
                const reader = new FileReader();
                reader.onload = (e) => { currentContent = arrayBufferToBase64(e.target.result); };
                reader.readAsArrayBuffer(file);
                return;
            }

            // PDF - display via iframe/object
            if (ext === 'pdf' || file.type === 'application/pdf') {
                const url = URL.createObjectURL(file);
                currentBlobUrl = url;
                const iframe = document.createElement('iframe');
                iframe.src = url; iframe.className = 'preview-iframe'; iframe.style.width = '100%'; iframe.style.minHeight = '480px'; iframe.style.border = 'none';
                previewContent.appendChild(iframe);
                // Store binary as base64 for encryption
                const reader = new FileReader(); reader.onload = (e) => { currentContent = arrayBufferToBase64(e.target.result); }; reader.readAsArrayBuffer(file);
                return;
            }

            // DOCX - convert via mammoth if available
            if (ext === 'docx') {
                if (!window.mammoth) {
                    const url = URL.createObjectURL(file);
                    currentBlobUrl = url;
                    previewContent.innerHTML = '<div>–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ DOCX —Ç—Ä–µ–±—É—é—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏. <a href="' + url + '" download="' + name + '">–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª</a></div>';
                    const reader = new FileReader(); reader.onload = (e) => { currentContent = arrayBufferToBase64(e.target.result); }; reader.readAsArrayBuffer(file);
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(evt) {
                    const arrayBuffer = evt.target.result;
                    window.mammoth.convertToHtml({ arrayBuffer: arrayBuffer })
                        .then(function(result) {
                            previewContent.innerHTML = result.value || '<div>–ü—É—Å—Ç–æ–π –¥–æ–∫—É–º–µ–Ω—Ç</div>';
                            // also set currentContent as base64 of binary
                            currentContent = arrayBufferToBase64(arrayBuffer);
                        }).catch(function(err){ previewContent.textContent = '–û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ docx: ' + (err && err.message); });
                };
                reader.readAsArrayBuffer(file);
                return;
            }

            // DOC (binary) - no browser preview; show download link
            if (ext === 'doc' || file.type === 'application/msword') {
                const url = URL.createObjectURL(file);
                currentBlobUrl = url;
                const a = document.createElement('a');
                a.href = url; a.download = name; a.textContent = '–°–∫–∞—á–∞—Ç—å DOC (–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)'; a.style.color = '#0369a1';
                previewContent.appendChild(a);
                const reader = new FileReader(); reader.onload = (e) => { currentContent = arrayBufferToBase64(e.target.result); }; reader.readAsArrayBuffer(file);
                return;
            }

            // –ó–∞–ø–∞—Å–Ω–æ–π –ø—É—Ç—å: –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª –∫–∞–∫ —Ç–µ–∫—Å—Ç
            const textReader = new FileReader();
            textReader.onload = function(e) {
                const txt = e.target.result || '';
                const pre = document.createElement('pre');
                pre.style.whiteSpace = 'pre-wrap'; pre.style.wordBreak = 'break-word'; pre.textContent = txt;
                previewContent.appendChild(pre);
                currentContent = txt;
            };
            // try read as text, if fails fallback to arraybuffer -> base64
            try { textReader.readAsText(file); } catch (err) { const ar = new FileReader(); ar.onload = function(ev) { currentContent = arrayBufferToBase64(ev.target.result); }; ar.readAsArrayBuffer(file); }
        }


        function sendshifr() {
            // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ (–∏–∑ commonFileInput –∏–ª–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ fileInput)
            const commonFileEl = document.getElementById('commonFileInput');
            const f = (commonFileEl && commonFileEl.files && commonFileEl.files[0]) || (fileInput && fileInput.files && fileInput.files[0]);
            
            // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª—é—á–∞ (–∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ input)
            const keyEl = document.getElementById('kuzKeyInput');
            const keyValue = keyEl ? keyEl.value.trim() : '';
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!f) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª!');
                return;
            }
            if (!keyValue) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á!');
                return;
            }
            
            // –°–æ–∑–¥–∞–Ω–∏–µ FormData –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
            const fd = new FormData();
            fd.append('file', f);
            fd.append('key', keyValue);
            var filename = f.name;
            filename = filename.slice(0, -4) + 'enc';
            
            // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            fetch('/cipher_file', {
                method: 'POST',
                body: fd
            })
            .then(res => {
                if (!res.ok) {
                    // –î–ª—è –æ—à–∏–±–æ–∫ —á–∏—Ç–∞–µ–º –æ—Ç–≤–µ—Ç –∫–∞–∫ —Ç–µ–∫—Å—Ç (–º–æ–∂–µ—Ç –±—ã—Ç—å JSON, HTML –∏–ª–∏ –¥—Ä—É–≥–æ–π —Ñ–æ—Ä–º–∞—Ç)
                    return res.text().then(errText => {
                        throw new Error(errText || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                    });
                }
               
                return res.blob();
            })
            .then(blob => {
                // –°–æ–∑–¥–∞—ë–º URL –¥–ª—è blob
                const url = URL.createObjectURL(blob);
                
                // –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç <a> –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                const link = document.createElement('a');
                link.href = url;
                
                link.download = filename;
                document.body.appendChild(link);
                link.click();  
                document.body.removeChild(link);
                
                // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–∞–º—è—Ç—å
                URL.revokeObjectURL(url);

            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', error);
                alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: ${error.message}`);
            });
        }

        function sendUnshifr() {
            console.log('sendUnshifr –≤—ã–∑–≤–∞–Ω–∞');
            // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ (–∏–∑ commonFileInput –∏–ª–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ fileInput)
            const kuzDecryptFileInputEl = document.getElementById('kuzDecryptFileInput');
        const f = kuzDecryptFileInputEl && kuzDecryptFileInputEl.files && kuzDecryptFileInputEl.files[0];
            // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª—é—á–∞ (–∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ input)
            const keyEl = document.getElementById('kuzKeyInput');
            const keyValue = keyEl ? keyEl.value.trim() : '';
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!f) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª!');
                return;
            }
            if (!keyValue) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á!');
                return;
            }
            
            // –°–æ–∑–¥–∞–Ω–∏–µ FormData –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
            const fd = new FormData();
            fd.append('file', f);
            fd.append('key', keyValue);
            var filename = f.name;
            filename = filename.slice(0, -4)+ 'dec' + '.docx';
            // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            fetch('/decipher_file', {
                method: 'POST',
                body: fd
            })
            .then(res => {
                if (!res.ok) {
                    // –î–ª—è –æ—à–∏–±–æ–∫ —á–∏—Ç–∞–µ–º –æ—Ç–≤–µ—Ç –∫–∞–∫ —Ç–µ–∫—Å—Ç (–º–æ–∂–µ—Ç –±—ã—Ç—å JSON, HTML –∏–ª–∏ –¥—Ä—É–≥–æ–π —Ñ–æ—Ä–º–∞—Ç)
                    return res.text().then(errText => {
                        throw new Error(errText || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                    });
                }
                // –ï—Å–ª–∏ —É—Å–ø–µ—Ö (200), –≤–æ–∑–≤—Ä–∞—â–∞–µ–º blob –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                return res.blob();
            })
            .then(blob => {
                // –°–æ–∑–¥–∞—ë–º URL –¥–ª—è blob
                const url = URL.createObjectURL(blob);
                
                // –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç <a> –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;  // –ò–º—è —Ñ–∞–π–ª–∞ (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç download_name –≤ Flask)
                document.body.appendChild(link);
                link.click();  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–ª–∏–∫–∞–µ–º –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                document.body.removeChild(link);
                
                // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–∞–º—è—Ç—å
                URL.revokeObjectURL(url);
                
                alert('–§–∞–π–ª –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω –∏ —Å–∫–∞—á–∞–Ω!');
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', error);
                alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: ${error.message}`);
            });
        }



        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Ö–µ—à–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞
        function sendHash() {
            // accept file from workspace input or older commonFileInput
            const commonFileEl = document.getElementById('commonFileInput');
            const f = (commonFileEl && commonFileEl.files && commonFileEl.files[0]) || (fileInput && fileInput.files && fileInput.files[0]);
            if (!f) { alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª!'); return; }
            const fd = new FormData(); fd.append('file', f); fd.a
            // show pending
            if (hashResult) { hashResult.style.display = 'none'; }
            if (hashValue) { hashValue.textContent = '–û–∂–∏–¥–∞–π—Ç–µ...'; hashValue.style.color = ''; if (hashValue.style) hashValue.style.whiteSpace = 'normal'; }
            fetch('/get_file_hash', { method:'POST', body: fd })
                .then(r => r.json())
                .then(data => {
                    if (!hashValue) return;
                    if (data && data.hash) {
                        // Format long hex into 64-char lines for readability
                        const hx = data.hash.replace(/\s+/g, '');
                        const parts = hx.match(/.{1,64}/g) || [hx];
                        hashValue.textContent = parts.join('\n');
                        if (hashValue.style) hashValue.style.whiteSpace = 'pre-wrap';
                        if (hashResult) hashResult.style.display = 'block';
                    }
                    else { hashValue.textContent = '–û—à–∏–±–∫–∞: ' + (data && data.error ? data.error : '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'); hashValue.style.color = 'red'; if (hashResult) hashResult.style.display = 'block'; }
                })
                .catch(e => { console.error('sendHash error', e); alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: ' + (e && e.message ? e.message : String(e))); });
        }

        function generateKey() {
            fetch('/home/gen_key')
                .then(res => {
                    if (!res.ok) {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                    return res.json();
                })
                .then(data => {
                    if (data && data.key) {
                        const keyArea = document.getElementById('keyArea');
                        const generatedKeyInput = document.getElementById('generatedKeyInput');
                        if (!keyArea || !generatedKeyInput) return;
                        generatedKeyInput.value = data.key;
                        keyArea.style.display = 'block';
                        console.log('–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á:', data.key);
                    } else {
                        const keyArea = document.getElementById('keyArea');
                        if (keyArea) {
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º innerHTML, —á—Ç–æ–±—ã –Ω–µ —Å–ª–æ–º–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É (input –∏ button –≤–Ω—É—Ç—Ä–∏)
                            keyArea.innerHTML = '<div style="color:red;">–û—à–∏–±–∫–∞: ' + (data && data.error ? data.error : '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</div>';
                            keyArea.style.display = 'block';
                        }
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–∞:', error);
                    const keyArea = document.getElementById('keyArea');
                    if (keyArea) {
                        keyArea.innerHTML = '<div style="color:red;">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞: ' + error.message + '</div>';
                        keyArea.style.display = 'block';
                    }
                });
        }



        function showKeyOnUI(key) {
            if (!keyArea || !generatedKeyInput) return; generatedKeyInput.value = key; keyArea.style.display = 'block';
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ (—á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏ –ø–æ–∫–∞–∑ –ø—Ä–µ–≤—å—é)
        if (uploadBtn && fileInput) uploadBtn.addEventListener('click', () => {
            const f = fileInput.files && fileInput.files[0];
            console.debug('upload clicked, file:', f && f.name);
            if (!f) { alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏'); return; }
            // Update mammoth notice status before previewing
            if (mammothNotice) mammothNotice.style.display = (window.mammoth ? 'none' : 'block');
            showPreviewForFile(f);
        });

        if (clearBtn) clearBtn.addEventListener('click', () => {
            if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞?')) return;
            currentContent = '';
            if (previewContent) previewContent.textContent = '–î–æ–∫—É–º–µ–Ω—Ç –æ—á–∏—â–µ–Ω';
            clearExistingBlob();
            if (fileInput) fileInput.value = null;
            if (selectedFileName) selectedFileName.textContent = '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
            if (signSelectedFileName) signSelectedFileName.textContent = '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
            if (signatureDate) signatureDate.textContent = '‚Äî';
            if (hashResult) hashResult.style.display = 'none';
            if (hashValue) hashValue.textContent = '';
            if (generatedKeyInput) generatedKeyInput.value = '';
            if (keyArea) keyArea.style.display = 'none';
        });

        if (encryptBtn) encryptBtn.addEventListener('click', () => {
            if (!currentContent) { alert('–ù–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è'); return; }
            const enc = sendshifr();
            
        });
// –ò–ù–≥–∞ –¥–ª—è —Å—Ö–µ–º —É—á–µ—Ç–∞ —á—Ç–æ–± —Å–æ—Ö—Ä–∞–Ω—è–ª—Å—è —Ñ–∞–π–ª
        if (sendBtn) sendBtn.addEventListener('click', () => {
            
            const f = fileInput.files && fileInput.files[0];
            if (!f) { 
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —É—á—ë—Ç!'); 
                return; 
            }
            if (!currentContent) {
                alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç (–Ω–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç")!');
                return;
            }
            const reader = new FileReader();
            
            reader.onload = function(evt) {
                const fileData = {
                    name: f.name,
                    type: f.type,
                    size: f.size,
                    lastModified: f.lastModified,
                    content: currentContent, 
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem('sentDocument', JSON.stringify(fileData));
                localStorage.setItem('documentSent', 'true');
                
                alert('–î–æ–∫—É–º–µ–Ω—Ç "' + f.name + '" –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ —É—á—ë—Ç–∞. –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É "–°—Ö–µ–º–∞ —É—á–µ—Ç–∞".');
                window.location.href = '/static/workflow.html';
            };
            if (typeof currentContent === 'string' && currentContent.includes('base64')) {
                const fileData = {
                    name: f.name,
                    type: f.type,
                    size: f.size,
                    lastModified: f.lastModified,
                    content: currentContent.split(',')[1] || currentContent,
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem('sentDocument', JSON.stringify(fileData));
                localStorage.setItem('documentSent', 'true');
                
                alert('–î–æ–∫—É–º–µ–Ω—Ç "' + f.name + '" –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ —É—á—ë—Ç–∞. –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É "–°—Ö–µ–º–∞ —É—á–µ—Ç–∞".');
                window.location.href = '/static/workflow.html';
            } else {
                reader.readAsDataURL(f);
            }
        });

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–¥–ø–∞–Ω–µ–ª–µ–π —Ä–µ–∂–∏–º–∞ "–ö—É–∑–Ω–µ—á–∏–∫" (–ó–∞—à–∏—Ñ—Ä–æ–≤–∞—Ç—å / –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å)
        if (kuzModeEncryptBtn) kuzModeEncryptBtn.addEventListener('click', () => {
            if (kuzModeEncryptBtn) kuzModeEncryptBtn.classList.add('primary');
            if (kuzModeDecryptBtn) kuzModeDecryptBtn.classList.remove('primary');
            if (kuzEncryptPanel) kuzEncryptPanel.style.display = 'block';
            if (kuzDecryptPanel) kuzDecryptPanel.style.display = 'none';
            // restore preview, actions and global file chooser when in encrypt subpanel
            try { const dp = document.getElementById('docPreview'); if (dp) dp.style.display = 'block'; } catch (e) {}
            try { const da = document.querySelector('.doc-actions'); if (da) da.style.display = 'grid'; } catch (e) {}
            try { const gf = document.getElementById('globalFileRow'); if (gf) gf.style.display = 'flex'; } catch (e) {}
            if (encryptBtn) encryptBtn.style.display = '';
        });
        if (kuzModeDecryptBtn) kuzModeDecryptBtn.addEventListener('click', () => {
            if (kuzModeDecryptBtn) kuzModeDecryptBtn.classList.add('primary');
            if (kuzModeEncryptBtn) kuzModeEncryptBtn.classList.remove('primary');
            if (kuzEncryptPanel) kuzEncryptPanel.style.display = 'none';
            if (kuzDecryptPanel) kuzDecryptPanel.style.display = 'block';
            // hide preview and common actions while in decrypt mode
            try { const dp = document.getElementById('docPreview'); if (dp) dp.style.display = 'none'; } catch (e) {}
            try { const da = document.querySelector('.doc-actions'); if (da) da.style.display = 'none'; } catch (e) {}
            try { const gf = document.getElementById('globalFileRow'); if (gf) gf.style.display = 'none'; } catch (e) {}
            if (encryptBtn) encryptBtn.style.display = 'none';
        });
        

        // –ü—Ä–æ—Ü–µ—Å—Å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –≤ —Ä–µ–∂–∏–º–µ "–ö—É–∑–Ω–µ—á–∏–∫"
        if (kuzDecryptChooseBtn && kuzDecryptFileInput) kuzDecryptChooseBtn.addEventListener('click', () => kuzDecryptFileInput.click());
        if (kuzDecryptFileInput) kuzDecryptFileInput.addEventListener('change', () => {
            const f = kuzDecryptFileInput.files && kuzDecryptFileInput.files[0];
            kuzDecryptSelectedFile.textContent = f ? f.name : '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
            // reset output state
            if (kuzDecryptOutput) kuzDecryptOutput.style.display = 'none';
            if (kuzDecryptText) kuzDecryptText.textContent = '';
        });
        // Show/hide key toggle
        // Show/hide toggle removed, no event listener required
        // –ù–∏–∂–Ω—è—è –∫–Ω–æ–ø–∫–∞ "–û—á–∏—Å—Ç–∏—Ç—å" –¥—É–±–ª–∏—Ä—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å (–≤–µ—Ä—Ö–Ω—é—é –∫–Ω–æ–ø–∫—É —Ä–∞–Ω–µ–µ —É–±—Ä–∞–ª–∏)
        if (kuzDecryptBottomClearBtn) kuzDecryptBottomClearBtn.addEventListener('click', () => {
            if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç?')) return;
            if (kuzDecryptFileInput) kuzDecryptFileInput.value = null;
            if (kuzDecryptSelectedFile) kuzDecryptSelectedFile.textContent = '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
            if (kuzDecryptOutput) kuzDecryptOutput.style.display = 'none';
            if (kuzDecryptText) kuzDecryptText.textContent = '';
        });
        if (kuzDecryptActionDownloadBtn) kuzDecryptActionDownloadBtn.addEventListener('click', () => {
            sendUnshifr()
        });
        
        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∏ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
        if (signatureCopyBtn) signatureCopyBtn.addEventListener('click', async () => {
            const txt = signatureDate && signatureDate.textContent ? signatureDate.textContent : '';
            if (!txt || txt === '‚Äî') { alert('–ù–µ—Ç –¥–∞—Ç—ã –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è'); return; }
            try {
                await navigator.clipboard.writeText(txt);
                // quick visual feedback
                const old = signatureCopyBtn.textContent; signatureCopyBtn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'; setTimeout(() => { signatureCopyBtn.textContent = old; }, 1500);
            } catch (e) {
                // fallback: try document.execCommand
                try {
                    const ta = document.createElement('textarea'); ta.value = txt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); alert('–î–∞—Ç–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞');
                } catch (ex) { alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞—Ç—É'); }
            }
        });

    })();
    });
    </script>
</body>
</html>
