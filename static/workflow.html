<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/static/index.css">
    <link rel="stylesheet" href="/static/workflow.css">
    <title>–°—Ö–µ–º–∞ —É—á–µ—Ç–∞</title>
</head>
<body>
    <div class="top-tabs" role="navigation">
        <div class="top-tabs-inner container">
            <ul class="top-tab-bar" role="tablist">
                <li class="top-tab-item" data-href="/static/index.html">–†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏</li>
                <li class="top-tab-item" data-href="/static/workflow.html">–°—Ö–µ–º–∞ —É—á–µ—Ç–∞</li>
                <li class="top-tab-item" data-href="/static/forms.html">–§–æ—Ä–º—ã —É—á–µ—Ç–∞</li>
            </ul>
            <div class="top-user-info" aria-hidden="true">
                <div class="user-avatar" title="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å">A</div>
                <div class="user-name">–ê–ª–µ–∫—Å–∞–Ω–¥—Ä</div>
            </div>
        </div>
    </div>

    <!-- –∫–æ–Ω—Ç–µ–Ω—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã –°—Ö–µ–º—ã —É—á–µ—Ç–∞ -->
    <div class="content-container">
        <h1 class="page-title">–°—Ö–µ–º—ã —É—á–µ—Ç–∞</h1>
        
        <!-- –ë–∞–Ω–Ω–µ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–æ–ª—É—á–µ–Ω–Ω–æ–º –¥–æ–∫—É–º–µ–Ω—Ç–µ -->
        <div id="documentNotification" class="document-notification" style="display: none;">
            <div class="notification-content">
                <span id="notificationText"></span>
                <button id="notificationDismiss" class="btn-small">‚úï</button>
            </div>
        </div>
        
        <div class="mode-description">
            <h2>–û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–∂–∏–º–∞</h2>
            <p>–ù–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ö–µ–º—É –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ.</p>
        </div>
        
        <div class="upload-section">
            <h2>–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç</h2>
            <div class="file-step">
                <span class="step-badge">1</span>
                <div class="file-select">
                    <input type="file" id="workflowFileInput" style="display: none;" accept=".txt,.pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png">
                    <button id="workflowUploadBtn" class="btn-small primary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
                    </button>
                    <span id="workflowFileName" class="file-name">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</span>
                    <button id="signDocumentBtn" class="btn-small primary" style="display: none;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"></path>
                            <path d="M4 6v12c0 1.1.9 2 2 2h14v-4"></path>
                            <path d="M18 12a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"></path>
                        </svg>
                        –ü–æ–¥–ø–∏—Å–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç
                    </button>
                </div>
            </div>
        </div>
        
        <div class="document-form">
            <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ–∫—É–º–µ–Ω—Ç–µ</h2>
            <div class="form-grid">
                <div class="form-group name-with-extension">
                    <label class="form-label">–ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
                    <div class="name-input-wrapper">
                        <input type="text" class="form-input name-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞" id="docName">
                        <div class="extension-display" id="extensionDisplay"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
                    <select class="form-input" id="docType">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞</option>
                        <option value="–ø–∏—Å—å–º–æ">–ü–∏—Å—å–º–æ</option>
                        <option value="–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</option>
                        <option value="–ø—Ä–∏–∫–∞–∑">–ü—Ä–∏–∫–∞–∑</option>
                        <option value="–ø—Ä–æ—Ç–æ–∫–æ–ª">–ü—Ä–æ—Ç–æ–∫–æ–ª</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">–û—Ç–∫—É–¥–∞ –ø–æ—Å—Ç—É–ø–∏–ª</label>
                    <input type="text" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è" id="docSource">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">–ü–æ–ª—è –¥–ª—è –≤–≤–æ–¥–∞</label>
                <textarea class="form-input" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞" id="docFields"></textarea>
            </div>
        </div>
        
        <div class="doc-actions">
            <div>
                <button class="generate-button" id="generateWorkflowBtn">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>
        
        <div class="workflow-section">
            <h2>–°—Ö–µ–º–∞ –ø—Ä–æ—Ö–æ–¥–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</h2>
            <div class="workflow-placeholder" id="workflowPlaceholder">
                <div class="preview-content-default">
                    –°—Ö–µ–º–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∞ –∑–¥–µ—Å—å –ø–æ—Å–ª–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const items = document.querySelectorAll('.top-tab-item');
        items.forEach(it => it.addEventListener('click', function(){ 
            const href = this.getAttribute('data-href'); 
            if (href) { 
                window.location.href = href; 
            } 
        }));
        
        const path = window.location.pathname || '/';
        if (path.endsWith('/static/workflow.html')) {
            const el = document.querySelector('.top-tab-item[data-href="/static/workflow.html"]'); 
            if (el) el.classList.add('active');
        }
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã 
        const workflowFileInput = document.getElementById('workflowFileInput');
        const workflowUploadBtn = document.getElementById('workflowUploadBtn');
        const workflowFileName = document.getElementById('workflowFileName');
        const docName = document.getElementById('docName');
        const docType = document.getElementById('docType');
        const docSource = document.getElementById('docSource');
        const extensionDisplay = document.getElementById('extensionDisplay');
        const generateButton = document.getElementById('generateWorkflowBtn');
        const signDocumentBtn = document.getElementById('signDocumentBtn');
        const workflowPlaceholder = document.getElementById('workflowPlaceholder');
        
        // —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Ñ–∞–π–ª–∞
        let currentWorkflowFile = null;
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
        if (workflowUploadBtn && workflowFileInput) {
            workflowUploadBtn.addEventListener('click', () => {
                workflowFileInput.click();
            });
            
            workflowFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    currentWorkflowFile = file;
                    workflowFileName.textContent = `${file.name} (${formatBytes(file.size)})`;
                    workflowFileName.classList.add('selected');
                    
                    // –∫–Ω–æ–ø–∫–∞ –ø–æ–¥–ø–∏—Å–∏
                    signDocumentBtn.style.display = 'inline-flex';
                    
                    // –ü–æ–ª—É—á–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
                    const fileName = file.name;
                    const extension = fileName.includes('.') 
                        ? fileName.substring(fileName.lastIndexOf('.')) 
                        : '';
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
                    if (extensionDisplay) {
                        extensionDisplay.textContent = extension;
                        extensionDisplay.style.display = extension ? 'flex' : 'none';
                    }
                    
                    // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–º–µ–Ω–∏ 
                    if (docName) {
                        const nameWithoutExt = extension 
                            ? fileName.substring(0, fileName.lastIndexOf('.'))
                            : fileName;
                        docName.value = nameWithoutExt;
                    }
                    
                    // –ò—Å—Ç–æ—á–Ω–∏–∫ –æ—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–º –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞
                    if (docSource) {
                        docSource.value = "";
                        docSource.focus();
                    }
                }
            });
        }
        
        // –ö–Ω–æ–ø–∫–∞ "–ü–æ–¥–ø–∏—Å–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç"
        if (signDocumentBtn) {
            signDocumentBtn.addEventListener('click', async function() {
                if (!currentWorkflowFile) {
                    alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –ø–æ–¥–ø–∏—Å–∏!');
                    return;
                }
                
                // –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                const originalText = signDocumentBtn.innerHTML;
                signDocumentBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12a9 9 0 11-6.219-8.56"></path>
                    </svg>
                    –í—ã—á–∏—Å–ª—è–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å—å...
                `;
                signDocumentBtn.disabled = true;
                
                try {
                    // FormData –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞
                    const formData = new FormData();
                    formData.append('file', currentWorkflowFile);
                    
                    // POST-–∑–∞–ø—Ä–æ—Å 
                    const response = await fetch('/sign_document', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.signature) {
                        alert('–¶–∏—Ñ—Ä–æ–≤–∞—è –ø–æ–¥–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ –≤—ã—á–∏—Å–ª–µ–Ω–∞!');
                    } else {
                        alert('–ü–æ–¥–ø–∏—Å—å –≤—ã—á–∏—Å–ª–µ–Ω–∞');
                    }
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–ø–∏—Å–∞–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞:', error);
                    alert(`–û—à–∏–±–∫–∞: ${error.message}`);
                } finally {
                    signDocumentBtn.innerHTML = originalText;
                    signDocumentBtn.disabled = false;
                }
            });
        }
        
      
        const documentSent = localStorage.getItem('documentSent');
        if (documentSent === 'true') {
            const fileData = JSON.parse(localStorage.getItem('sentDocument') || '{}');
            
            if (fileData && fileData.name) {
                // —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                const notification = document.getElementById('documentNotification');
                const notificationText = document.getElementById('notificationText');
                
                if (notification && notificationText) {
                    notification.style.display = 'block';
                    notificationText.textContent = `–ü–æ–ª—É—á–µ–Ω –¥–æ–∫—É–º–µ–Ω—Ç: ${fileData.name} (${formatBytes(fileData.size)})`;
                }
                
                if (workflowFileName) {
                    workflowFileName.textContent = `–ü–æ–ª—É—á–µ–Ω: ${fileData.name} (${formatBytes(fileData.size)})`;
                    workflowFileName.style.color = '#059669';
                    workflowFileName.style.fontWeight = 'bold';
                }
                
                signDocumentBtn.style.display = 'inline-flex';
                
                const fileName = fileData.name;
                const extension = fileName.includes('.') 
                    ? fileName.substring(fileName.lastIndexOf('.')) 
                    : '';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
                if (extensionDisplay) {
                    extensionDisplay.textContent = extension;
                    extensionDisplay.style.display = extension ? 'flex' : 'none';
                }
                
                // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–º–µ–Ω–∏ (–±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è)
                if (docName) {
                    const nameWithoutExt = extension 
                        ? fileName.substring(0, fileName.lastIndexOf('.'))
                        : fileName;
                    docName.value = nameWithoutExt;
                }
                
                if (docSource) {
                    docSource.value = ""; 
                    docSource.focus(); 
                }
                
                // –æ–±—ä–µ–∫—Ç File –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                if (fileData.content) {
                    try {
                        const byteCharacters = atob(fileData.content);
                        const byteNumbers = new Array(byteCharacters.length);
                        for (let i = 0; i < byteCharacters.length; i++) {
                            byteNumbers[i] = byteCharacters.charCodeAt(i);
                        }
                        const byteArray = new Uint8Array(byteNumbers);
                        const blob = new Blob([byteArray], { type: fileData.type });
                        
                        currentWorkflowFile = new File([blob], fileData.name, {
                            type: fileData.type,
                            lastModified: fileData.lastModified
                        });
                    } catch (e) {
                        console.error('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞:', e);
                    }
                }
                
                // –û—á–∏—â–∞–µ–º —Ñ–ª–∞–≥ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
                localStorage.removeItem('documentSent');
                localStorage.removeItem('sentDocument');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }
        
        if (generateButton) {
            generateButton.addEventListener('click', function() {
                const docNameValue = docName.value.trim();
                const docTypeValue = docType.value;
                const docSourceValue = docSource.value.trim();
                
                if (!docNameValue) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –∫—Ä–∞—Ç–∫–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞!');
                    docName.focus();
                    return;
                }
                
                if (!docTypeValue) {
                    alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞!');
                    docType.focus();
                    return;
                }
                
                if (!docSourceValue) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞!');
                    docSource.focus();
                    return;
                }
                
                if (!currentWorkflowFile) {
                    alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏!');
                    return;
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ
                alert(`–î–æ–∫—É–º–µ–Ω—Ç "${docNameValue}" —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –∏ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω —Å–æ–≥–ª–∞—Å–Ω–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ö–µ–º–µ —É—á–µ—Ç–∞.\n–¢–∏–ø: ${docTypeValue}\n–ò—Å—Ç–æ—á–Ω–∏–∫: ${docSourceValue}`);
                
                workflowPlaceholder.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 24px; color: #94a3b8;">‚è≥</div>
                        <div style="margin-top: 15px; color: #475569;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ö–µ–º—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞...</div>
                    </div>
                `;
                
                
                const schemeUrl = `/static/schemes/${docTypeValue}.png`;
                
                // 3.  –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ö–µ–º—ã
                const img = new Image();
                
                img.onload = function() {
                    // –£—Å–ø–µ—à–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ 
                    workflowPlaceholder.innerHTML = `
                        <div style="width: 100%; height: 100%; overflow: auto; display: flex; align-items: flex-start; justify-content: center;">
                            <img src="${schemeUrl}" 
                                alt="–°—Ö–µ–º–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è ${docTypeValue}" 
                                style="max-width: 100%; height: auto; border-radius: 8px; border: 1px solid #ddd; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        </div>
                    `;
                };
                
                img.onerror = function() {
                    // –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ö–µ–º—ã
                    workflowPlaceholder.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <div style="font-size: 48px; color: #94a3b8;">üìÑ</div>
                            <div style="margin-top: 15px; font-weight: bold; color: #475569;">
                                –°—Ö–µ–º–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
                            </div>
                            <div style="margin-top: 10px; color: #64748b; font-size: 14px;">
                                –§–∞–π–ª: static/schemes/${docTypeValue}.png
                            </div>
                        </div>
                    `;
                };
                
                img.src = schemeUrl;
                
                // –ó–¥–µ—Å—å –ø–æ—Ç–æ–º –¥–æ–±–∞–≤–ª—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–∞–π–ª–∞ –≤ –±–¥
            });
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        const notificationDismiss = document.getElementById('notificationDismiss');
        if (notificationDismiss) {
            notificationDismiss.addEventListener('click', function() {
                const notification = document.getElementById('documentNotification');
                if (notification) {
                    notification.style.display = 'none';
                }
            });
        }
    });
    </script>
</body>
</html>