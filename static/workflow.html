<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/static/index.css">
    <link rel="stylesheet" href="/static/workflow.css">
    <title>Схема учета</title>
</head>
<body>
    <div class="top-tabs" role="navigation">
        <div class="top-tabs-inner container">
            <ul class="top-tab-bar" role="tablist">
                <li class="top-tab-item" data-href="/static/index.html">Работа с файлами</li>
                <li class="top-tab-item" data-href="/static/workflow.html">Схема учета</li>
                <li class="top-tab-item" data-href="/static/forms.html">Формы учета</li>
            </ul>
            <div class="top-user-info" aria-hidden="true">
                <div class="user-avatar" title="Пользователь">A</div>
                <div class="user-name">Александр</div>
            </div>
        </div>
    </div>

    <!-- Добавляем контент страницы Схемы учета -->
    <div class="content-container">
        <h1 class="page-title">Схемы учета</h1>
        
        <!-- Баннер уведомления о полученном документе -->
        <div id="documentNotification" class="document-notification" style="display: none;">
            <div class="notification-content">
                <span id="notificationText"></span>
                <button id="notificationDismiss" class="btn-small">✕</button>
            </div>
        </div>
        
        <div class="mode-description">
            <h2>Описание режима</h2>
            <p>На этой странице вы можете загрузить документы и просмотреть схему прохождения документов в системе.</p>
        </div>
        
        <div class="upload-section">
            <h2>Загрузить документ</h2>
            <div class="file-step">
                <span class="step-badge">1</span>
                <div class="file-select">
                    <input type="file" id="workflowFileInput" style="display: none;" accept=".txt,.pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png">
                    <button id="workflowUploadBtn" class="btn-small primary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        Выбрать файл
                    </button>
                    <span id="workflowFileName" class="file-name">Файл не выбран</span>
                </div>
            </div>
        </div>
        
        <div class="document-form">
            <h2>Информация о документе</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Краткое наименование документа</label>
                    <input type="text" class="form-input" placeholder="Введите наименование документа" id="docName">
                </div>
                <div class="form-group">
                    <label class="form-label">Тип документа</label>
                    <input type="text" class="form-input" placeholder="Выберите тип документа" id="docType">
                </div>
                <div class="form-group">
                    <label class="form-label">Откуда поступил</label>
                    <input type="text" class="form-input" placeholder="Укажите источник" id="docSource" value="Главная страница (Кузнечик)">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Поля для ввода</label>
                <textarea class="form-input" rows="4" placeholder="Введите дополнительные данные документа" id="docFields"></textarea>
            </div>
        </div>
        
        <div class="doc-actions">
            <div>
                <button class="generate-button" id="generateWorkflowBtn">Сформировать</button>
            </div>
        </div>
        
        <div class="workflow-section">
            <h2>Схема прохода документов</h2>
            <div class="workflow-placeholder">
                <div class="preview-content-default">
                    Схема прохождения документов будет отображена здесь
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const items = document.querySelectorAll('.top-tab-item');
        items.forEach(it => it.addEventListener('click', function(){ 
            const href = this.getAttribute('data-href'); 
            if (href) { 
                window.location.href = href; 
            } 
        }));
        
        const path = window.location.pathname || '/';
        if (path.endsWith('/static/workflow.html')) {
            const el = document.querySelector('.top-tab-item[data-href="/static/workflow.html"]'); 
            if (el) el.classList.add('active');
        }
        
        // Элементы 
        const workflowFileInput = document.getElementById('workflowFileInput');
        const workflowUploadBtn = document.getElementById('workflowUploadBtn');
        const workflowFileName = document.getElementById('workflowFileName');
        const docName = document.getElementById('docName');
        const docType = document.getElementById('docType');
        const docSource = document.getElementById('docSource');
        const generateButton = document.getElementById('generateWorkflowBtn');
        
        // хранение текущего файла
        let currentWorkflowFile = null;
        
        // Обработка выбора 
        if (workflowUploadBtn && workflowFileInput) {
            workflowUploadBtn.addEventListener('click', () => {
                workflowFileInput.click();
            });
            
            workflowFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    currentWorkflowFile = file;
                    workflowFileName.textContent = `${file.name} (${formatBytes(file.size)})`;
                    workflowFileName.classList.add('selected');
                    
                    // Автозаполнение формы
                    if (docName) {
                        const nameWithoutExt = file.name.replace(/\.[^/.]+$/, "");
                        docName.value = nameWithoutExt;
                    }
                    
                    if (docType) {
                        const ext = file.name.split('.').pop().toUpperCase();
                        docType.value = `${ext} файл`;
                    }
                    
                    if (docSource) {
                        docSource.value = "Загружен вручную";
                    }
                }
            });
        }
        
        // Проверяем, есть ли отправленный документ из index.html
        const documentSent = localStorage.getItem('documentSent');
        if (documentSent === 'true') {
            const fileData = JSON.parse(localStorage.getItem('sentDocument') || '{}');
            
            if (fileData && fileData.name) {
                // уведомление
                const notification = document.getElementById('documentNotification');
                const notificationText = document.getElementById('notificationText');
                
                if (notification && notificationText) {
                    notification.style.display = 'block';
                    notificationText.textContent = `Получен документ: ${fileData.name} (${formatBytes(fileData.size)})`;
                }
                
                if (workflowFileName) {
                    workflowFileName.textContent = `Получен: ${fileData.name} (${formatBytes(fileData.size)})`;
                    workflowFileName.style.color = '#059669';
                    workflowFileName.style.fontWeight = 'bold';
                }
                
                if (docName) {
                    const nameWithoutExt = fileData.name.replace(/\.[^/.]+$/, "");
                    docName.value = nameWithoutExt;
                }
                
                if (docType) {
                    const ext = fileData.name.split('.').pop().toUpperCase();
                    docType.value = `${ext} файл`;
                }
                
                if (docSource) {
                    docSource.value = "Главная страница (Кузнечик)";
                }
                
                // объект File из сохраненных данных
                if (fileData.content) {
                    try {
                        const byteCharacters = atob(fileData.content);
                        const byteNumbers = new Array(byteCharacters.length);
                        for (let i = 0; i < byteCharacters.length; i++) {
                            byteNumbers[i] = byteCharacters.charCodeAt(i);
                        }
                        const byteArray = new Uint8Array(byteNumbers);
                        const blob = new Blob([byteArray], { type: fileData.type });
                        
                        currentWorkflowFile = new File([blob], fileData.name, {
                            type: fileData.type,
                            lastModified: fileData.lastModified
                        });
                    } catch (e) {
                        console.error('Ошибка восстановления файла:', e);
                    }
                }
                
                // Очищаем флаг после обработки
                localStorage.removeItem('documentSent');
                localStorage.removeItem('sentDocument');
            }
        }
        
        // Функция для форматирования размера файла
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }
        
        // Обработка кнопки "Сформировать"
        if (generateButton) {
            generateButton.addEventListener('click', function() {
                const docNameValue = docName.value.trim();
                
                if (!docNameValue) {
                    alert('Введите краткое наименование документа!');
                    return;
                }
                
                if (!currentWorkflowFile) {
                    alert('Выберите файл для загрузки!');
                    return;
                }
                
                alert(`Документ "${docNameValue}" успешно загружен и сформирован согласно выбранной схеме учета.`);
                
                // Здесь потом добавлю отправку файла в бд
                
                if (workflowFileInput) workflowFileInput.value = '';
                if (workflowFileName) {
                    workflowFileName.textContent = 'Файл не выбран';
                    workflowFileName.style.color = '';
                    workflowFileName.style.fontWeight = '';
                }
                if (docName) docName.value = '';
                if (docType) docType.value = '';
                if (docSource) docSource.value = '';
                currentWorkflowFile = null;
            });
        }
        
        // Закрытие уведомления
        const notificationDismiss = document.getElementById('notificationDismiss');
        if (notificationDismiss) {
            notificationDismiss.addEventListener('click', function() {
                const notification = document.getElementById('documentNotification');
                if (notification) {
                    notification.style.display = 'none';
                }
            });
        }
    });
    </script>
</body>
</html>